새 설계 요구사항을 반영한 통합 설계안을 정리 중입니다. 현재 파일 구조를 확인하고 정규화된 데이터 모델로 매핑합니다.


[3 tools called]


# TR_DocHub_2026.xlsm 정규화 통합 설계안 v2.0

## 1. 시트 구성 (정규화 모델)

```
[필수 시트]
1. S_Voyages          [Source] 항차 일정 (tbl_Voyage) - PK: VoyageID
2. M_DocCatalog       [Master] 문서 카탈로그 (tbl_DocCatalog) - PK: DocCode
3. M_Parties          [Master] Responsible Party 마스터 (tbl_Party) - PK: PartyID
4. R_DeadlineRules    [Rules] DueDate 룰테이블 (tbl_RuleDeadline) - PK: RuleID
5. T_Tracker          [Transaction] 제출 통제 원장 (tbl_Tracker) - PK: VoyageID+DocCode
6. D_Dashboard        [Dashboard] Responsible Party 중심 KPI
7. C_Config           [Config] 경로/임계값/공휴일
8. VBA_Pasteboard     [Code] VBA 복붙용 설치 보드

[옵션 시트]
9. L_StatusLog         [Log] 상태/책임자 변경 이력 (tbl_StatusLog)
10. Lists              [Config] 드롭다운 소스 (hidden)
11. Instructions       [Guide] 사용법
```

---

## 2. 테이블 구조 (정규화 스키마)

### 2.1 S_Voyages (tbl_Voyage)

| 컬럼명 | 타입 | PK | 필수 | 설명 |
|--------|------|----|----|------|
| VoyageID | Text | ✅ | ✅ | V01, V02 등 (고유) |
| VoyageName | Text | ❌ | ✅ | Voyage 1, Voyage 2 등 (표시명) |
| TR Units | Text | ❌ | ✅ | TR 1-2, TR 3-4 등 |
| MZP Arrival | Date | ❌ | ✅ | Anchor 필드 |
| Load-out | Date | ❌ | ✅ | Anchor 필드 |
| MZP Departure | Date | ❌ | ✅ | Anchor 필드 |
| AGI Arrival | Date | ❌ | ✅ | Anchor 필드 |
| Doc Deadline | Date | ❌ | ⚪ | Anchor 필드 (별도 기준일) |
| Land Permit By | Date | ❌ | ⚪ | Anchor 필드 |
| Project | Text | ❌ | ⚪ | 프로젝트 코드 |
| Lot | Text | ❌ | ⚪ | Lot 번호 |
| Remarks | Text | ❌ | ⚪ | 비고 |

**데이터 유효성:**
- VoyageID: 고유성 검증 (VBA 또는 수식)
- 날짜 필드: Date validation
- Anchor 필드 누락 시 경고 (VBA ValidateBeforeExport)

### 2.2 M_DocCatalog (tbl_DocCatalog)

| 컬럼명 | 타입 | PK | 필수 | 설명 |
|--------|------|----|----|------|
| DocCode | Text | ✅ | ✅ | GATEPASS, CUSTOMS, PERMIT 등 (고유) |
| DocName | Text | ❌ | ✅ | 문서명 |
| DocCategory | Text | ❌ | ✅ | Gate/Customs/Permit/Transport/Other |
| DefaultResponsiblePartyID | Text | ❌ | ✅ | FK → M_Parties[PartyID] |
| RequiredFlag | Text | ❌ | ✅ | Y/N (드롭다운) |
| EvidenceRequiredFlag | Text | ❌ | ✅ | Y/N (드롭다운) |
| ActiveFlag | Text | ❌ | ✅ | Y/N (드롭다운) |
| DocDescription | Text | ❌ | ⚪ | 설명 |

**데이터 유효성:**
- DocCode: 고유성 검증
- DefaultResponsiblePartyID: Lists!$F$2:$F$8 (M_Parties 참조)
- RequiredFlag/EvidenceRequiredFlag/ActiveFlag: Lists!$D$2:$D$3 (Y/N)

### 2.3 M_Parties (tbl_Party)

| 컬럼명 | 타입 | PK | 필수 | 설명 |
|--------|------|----|----|------|
| PartyID | Text | ✅ | ✅ | FF, CUSTBROKER, EPC, TRCON 등 |
| PartyName | Text | ❌ | ✅ | 표시명 |
| OwnerEmail | Text | ❌ | ⚪ | 이메일 |
| Contact | Text | ❌ | ⚪ | 연락처 |
| ActiveFlag | Text | ❌ | ✅ | Y/N |

### 2.4 R_DeadlineRules (tbl_RuleDeadline)

| 컬럼명 | 타입 | PK | 필수 | 설명 |
|--------|------|----|----|------|
| RuleID | Text | ✅ | ✅ | R001, R002 등 |
| DocCode | Text | ❌ | ✅ | FK → M_DocCatalog[DocCode] |
| AnchorField | Text | ❌ | ✅ | S_Voyages 컬럼명과 동일 (MZP Arrival, Load-out 등) |
| OffsetDays | Integer | ❌ | ✅ | 음수 가능 (-1, -2 등) |
| CalendarType | Text | ❌ | ✅ | CAL(일반) / WD(평일) |
| Priority | Integer | ❌ | ✅ | 낮을수록 우선 (1, 2, 3...) |
| ActiveFlag | Text | ❌ | ✅ | Y/N |
| AppliesIf | Text | ❌ | ⚪ | 조건 문자열 (최소 구현에서는 빈값) |

**룰 예시:**
```
RuleID: R001
DocCode: GATEPASS
AnchorField: Load-out
OffsetDays: -1
CalendarType: CAL
Priority: 1
ActiveFlag: Y

RuleID: R002
DocCode: CUSTOMS
AnchorField: Doc Deadline
OffsetDays: -2
CalendarType: WD
Priority: 1
ActiveFlag: Y
```

### 2.5 T_Tracker (tbl_Tracker) - 핵심 원장

| 컬럼명 | 타입 | PK | 필수 | 설명 |
|--------|------|----|----|------|
| VoyageID | Text | ✅ | ✅ | FK → S_Voyages[VoyageID] |
| DocCode | Text | ✅ | ✅ | FK → M_DocCatalog[DocCode] |
| ResponsiblePartyID | Text | ❌ | ✅ | FK → M_Parties[PartyID] (기본값=DocCatalog, 변경 가능) |
| AnchorField | Text | ❌ | ✅ | 룰에서 자동 채움 |
| AnchorDate | Date | ❌ | ✅ | 자동 계산: S_Voyages의 해당 날짜 |
| OffsetDays | Integer | ❌ | ✅ | 룰에서 자동 채움 |
| DueDate | Date | ❌ | ✅ | 자동 계산: `AnchorDate + OffsetDays` (WD면 WORKDAY.INTL) |
| Status | Text | ❌ | ✅ | 드롭다운: Not Started/In Progress/Submitted/Accepted/Rejected/Waived |
| SubmittedDate | Date | ❌ | ⚪ | 사용자 입력 |
| AcceptedDate | Date | ❌ | ⚪ | 사용자 입력 |
| EvidenceLink | Hyperlink | ❌ | ⚪ | 파일 경로/하이퍼링크 |
| EvidenceNote | Text | ❌ | ⚪ | 증빙 메타 |
| LastUpdatedBy | Text | ❌ | ✅ | 자동 (Worksheet_Change) |
| LastUpdatedAt | Date/Time | ❌ | ✅ | 자동 (Worksheet_Change) |
| RAG | Text | ❌ | ✅ | 계산 필드: Overdue/DueSoon/OK |

**DueDate 계산 수식 (A안 - 순수 수식):**

```excel
# AnchorDate 수식 (개념):
=INDEX(tbl_Voyage, MATCH([@VoyageID], tbl_Voyage[VoyageID], 0), MATCH([@AnchorField], tbl_Voyage[#Headers], 0))

# DueDate 수식 (WD인 경우):
=IF([@CalendarType]="WD",
    WORKDAY.INTL([@AnchorDate], [@OffsetDays], "0000011", Holidays!$A$2:$A$100),
    [@AnchorDate] + [@OffsetDays]
)

# RAG 계산 필드:
=IF([@DueDate]="", "",
    IF([@DueDate]<TODAY(), "Overdue",
    IF([@DueDate]<=TODAY()+7, "DueSoon", "OK"))
)
```

---

## 3. VBA 최소 기능 세트 (운영 필수)

### 3.1 modOperations (Must-have)

```vba
Attribute VB_Name = "modOperations"
Option Explicit

'===============================================================================
' OPERATIONS MODULE - Minimum Essential Functions
'===============================================================================

'------------------------------------------------------------------------------
' 1. InitializeWorkbook()
'------------------------------------------------------------------------------
Public Sub InitializeWorkbook()
    ' 테이블 존재/헤더 검증
    ' Named Range/드롭다운/조건부서식 재적용
    ' Config 기본값 설정
End Sub

'------------------------------------------------------------------------------
' 2. GenerateTrackerRows(voyageID or All)
'------------------------------------------------------------------------------
Public Sub GenerateTrackerRows(Optional voyageID As String = "ALL")
    ' tbl_Voyage의 항차를 기준으로
    ' tbl_DocCatalog(Active+Required)와 조인해
    ' tbl_Tracker 행 생성 (중복 방지)
    
    ' 로직:
    ' 1. For Each Voyage in tbl_Voyage
    ' 2. For Each Doc in tbl_DocCatalog (ActiveFlag=Y AND RequiredFlag=Y)
    ' 3. If (VoyageID, DocCode) not exists in tbl_Tracker Then
    ' 4.     Create new row with defaults
    ' 5.     Set ResponsiblePartyID = DocCatalog.DefaultResponsiblePartyID
End Sub

'------------------------------------------------------------------------------
' 3. RecalcDeadlines()
'------------------------------------------------------------------------------
Public Sub RecalcDeadlines()
    ' tbl_RuleDeadline 기반으로
    ' AnchorField/OffsetDays/AnchorDate/DueDate 갱신
    
    ' 로직 (B안 - VBA 재계산):
    ' 1. For Each Row in tbl_Tracker
    ' 2.   Find matching Rule (DocCode, ActiveFlag=Y, Priority 최소)
    ' 3.   Set AnchorField = Rule.AnchorField
    ' 4.   Set OffsetDays = Rule.OffsetDays
    ' 5.   Get AnchorDate from tbl_Voyage[VoyageID][AnchorField]
    ' 6.   Calculate DueDate = AnchorDate + OffsetDays (WD면 WORKDAY.INTL)
    ' 7.   Set RAG = CalculateRAG(DueDate)
End Sub

'------------------------------------------------------------------------------
' 4. ValidateBeforeExport()
'------------------------------------------------------------------------------
Public Sub ValidateBeforeExport() As Collection
    ' 필수 Anchor 누락, Status=Submitted인데 EvidenceLink 없음 등
    ' "운영 규칙" 위반을 리스트업
    
    ' 검증 항목:
    ' 1. tbl_Voyage에서 Anchor 필드 누락 (MZP Arrival, Load-out 등)
    ' 2. tbl_Tracker에서 Status=Submitted AND EvidenceRequiredFlag=Y AND EvidenceLink=""
    ' 3. tbl_Tracker에서 DueDate="" (룰 매칭 실패)
    ' 4. ResponsiblePartyID가 M_Parties에 없음
End Sub

'------------------------------------------------------------------------------
' 5. ExportVoyagePack(voyageID)
'------------------------------------------------------------------------------
Public Sub ExportVoyagePack(voyageID As String)
    ' 폴더 생성 → (1) Dashboard/Tracker PDF, (2) CSV 2~3종, (3) Evidence Index CSV
    
    ' 출력물:
    ' 1. Dashboard PDF (ExportAsFixedFormat)
    ' 2. Tracker CSV (tbl_Tracker 필터링)
    ' 3. Voyage Schedule CSV (tbl_Voyage 필터링)
    ' 4. Evidence Index CSV (EvidenceLink 목록)
End Sub
```

### 3.2 modDashboard (Should-have, 옵션)

```vba
Attribute VB_Name = "modDashboard"
Option Explicit

'------------------------------------------------------------------------------
' RefreshDashboard(partyID)
'------------------------------------------------------------------------------
Public Sub RefreshDashboard(Optional partyID As String = "ALL")
    ' Party 선택 시 필터 적용
    ' KPI 재계산
    ' 조건부서식 재적용
End Sub

'------------------------------------------------------------------------------
' SmartFilterToParty(partyID)
'------------------------------------------------------------------------------
Public Sub SmartFilterToParty(partyID As String)
    ' D_Dashboard와 T_Tracker 동기 필터
End Sub
```

---

## 4. Python 빌더 업데이트 (정규화 모델 반영)

### 4.1 create_tr_document_tracker_v2.py 변경사항

시트명 변경 및 테이블 구조 정규화:

```python
# 기존:
ws_voy = wb.create_sheet("Voyage_Schedule")
ws_doc = wb.create_sheet("Doc_Matrix")
ws_tr = wb.create_sheet("Document_Tracker")
ws_ct = wb.create_sheet("Party_Contacts")

# 변경 후:
ws_voy = wb.create_sheet("S_Voyages")
ws_doc = wb.create_sheet("M_DocCatalog")
ws_tr = wb.create_sheet("T_Tracker")
ws_party = wb.create_sheet("M_Parties")
ws_rules = wb.create_sheet("R_DeadlineRules")
ws_dash = wb.create_sheet("D_Dashboard")
ws_config = wb.create_sheet("C_Config")
```

S_Voyages 테이블 구조 (VoyageID 추가):

```python
headers_voy = [
    "VoyageID", "VoyageName", "TR Units",
    "MZP Arrival", "Load-out", "MZP Departure", "AGI Arrival",
    "Doc Deadline", "Land Permit By",
    "Project", "Lot", "Remarks"
]

# Sample data:
sample_rows = [
    ("V01", "Voyage 1", "TR 1-2", "01-27", "01-29~30", "02-01", "02-02", None, None, "HVDC", "Lot-1", ""),
    ("V02", "Voyage 2", "TR 3-4", "02-06", "02-07~08", "02-10", "02-11", None, None, "HVDC", "Lot-1", ""),
    # ...
]
```

M_DocCatalog 테이블 구조:

```python
headers_doc = [
    "DocCode", "DocName", "DocCategory",
    "DefaultResponsiblePartyID", "RequiredFlag", "EvidenceRequiredFlag", "ActiveFlag",
    "DocDescription"
]

# Sample data:
default_docs = [
    ("GATEPASS", "Gate Pass Application", "Gate", "FF", "Y", "Y", "Y", "Port gate pass"),
    ("CUSTOMS", "Customs Declaration", "Customs", "CUSTBROKER", "Y", "Y", "Y", "Customs clearance docs"),
    # ...
]
```

M_Parties 테이블 생성:

```python
def create_m_parties_sheet(wb):
    """Create M_Parties master sheet"""
    ws_party = wb.create_sheet("M_Parties")
    ws_party["A1"] = "Responsible Party Master"
    ws_party["A1"].font = Font(bold=True, size=16, color="1E3A5F")
    
    headers_party = ["PartyID", "PartyName", "OwnerEmail", "Contact", "ActiveFlag"]
    header_row = 3
    
    for col, h in enumerate(headers_party, start=1):
        cell = ws_party.cell(row=header_row, column=col, value=h)
        cell.font = font_header
        cell.fill = header_fill
        cell.alignment = align_center
        cell.border = border_thin
    
    # Sample parties
    parties_data = [
        ("FF", "Freight Forwarder", "ff@company.com", "", "Y"),
        ("CUSTBROKER", "Customs Broker", "customs@company.com", "", "Y"),
        ("EPC", "EPC Contractor", "epc@company.com", "", "Y"),
        ("TRCON", "Transport Contractor", "transport@company.com", "", "Y"),
        ("PORT", "Port Authority", "port@authority.ae", "", "Y"),
    ]
    
    start_row = header_row + 1
    for i, (pid, name, email, contact, active) in enumerate(parties_data):
        r = start_row + i
        ws_party.cell(r, 1).value = pid
        ws_party.cell(r, 2).value = name
        ws_party.cell(r, 3).value = email
        ws_party.cell(r, 4).value = contact
        ws_party.cell(r, 5).value = active
        
        for c in range(1, 6):
            cell = ws_party.cell(r, c)
            cell.border = border_thin
            cell.font = font_normal
    
    add_table(ws_party, "tbl_Party", header_row, 1, start_row + len(parties_data) - 1, len(headers_party))
    
    # Data validation
    dv_active = DataValidation(type="list", formula1="=Lists!$D$2:$D$3", allow_blank=False)
    ws_party.add_data_validation(dv_active)
    dv_active.add(f"E{start_row}:E5000")
```

R_DeadlineRules 테이블 생성:

```python
def create_r_deadline_rules_sheet(wb):
    """Create R_DeadlineRules sheet"""
    ws_rules = wb.create_sheet("R_DeadlineRules")
    ws_rules["A1"] = "Deadline Rules (DocCode → AnchorField + OffsetDays)"
    ws_rules["A1"].font = Font(bold=True, size=16, color="1E3A5F")
    
    headers_rules = [
        "RuleID", "DocCode", "AnchorField", "OffsetDays",
        "CalendarType", "Priority", "ActiveFlag", "AppliesIf"
    ]
    header_row = 3
    
    for col, h in enumerate(headers_rules, start=1):
        cell = ws_rules.cell(row=header_row, column=col, value=h)
        cell.font = font_header
        cell.fill = header_fill
        cell.alignment = align_center
        cell.border = border_thin
    
    # Sample rules
    rules_data = [
        ("R001", "GATEPASS", "Load-out", -1, "CAL", 1, "Y", ""),
        ("R002", "CUSTOMS", "Doc Deadline", -2, "WD", 1, "Y", ""),
        ("R003", "PERMIT", "MZP Arrival", 0, "CAL", 1, "Y", ""),
        # ...
    ]
    
    start_row = header_row + 1
    for i, (rid, doc, anchor, offset, cal, prio, active, cond) in enumerate(rules_data):
        r = start_row + i
        ws_rules.cell(r, 1).value = rid
        ws_rules.cell(r, 2).value = doc
        ws_rules.cell(r, 3).value = anchor
        ws_rules.cell(r, 4).value = offset
        ws_rules.cell(r, 5).value = cal
        ws_rules.cell(r, 6).value = prio
        ws_rules.cell(r, 7).value = active
        ws_rules.cell(r, 8).value = cond
        
        for c in range(1, 9):
            cell = ws_rules.cell(r, c)
            cell.border = border_thin
            cell.font = font_normal
    
    add_table(ws_rules, "tbl_RuleDeadline", header_row, 1, start_row + len(rules_data) - 1, len(headers_rules))
    
    # Data validation
    dv_doccode = DataValidation(type="list", formula1="=M_DocCatalog[DocCode]", allow_blank=False)
    dv_anchor = DataValidation(type="list", formula1="=S_Voyages[#Headers]", allow_blank=False)
    dv_cal = DataValidation(type="list", formula1='"CAL,WD"', allow_blank=False)
    dv_active = DataValidation(type="list", formula1="=Lists!$D$2:$D$3", allow_blank=False)
    
    ws_rules.add_data_validation(dv_doccode)
    ws_rules.add_data_validation(dv_anchor)
    ws_rules.add_data_validation(dv_cal)
    ws_rules.add_data_validation(dv_active)
    
    dv_doccode.add(f"B{start_row}:B5000")
    dv_anchor.add(f"C{start_row}:C5000")
    dv_cal.add(f"E{start_row}:E5000")
    dv_active.add(f"G{start_row}:G5000")
```

T_Tracker 테이블 구조 (정규화):

```python
tracker_headers = [
    "VoyageID", "DocCode",  # Composite PK
    "ResponsiblePartyID", "AnchorField", "AnchorDate", "OffsetDays", "DueDate",
    "Status", "SubmittedDate", "AcceptedDate",
    "EvidenceLink", "EvidenceNote",
    "LastUpdatedBy", "LastUpdatedAt", "RAG"
]

# DueDate 수식 (A안 - 순수 수식):
# AnchorDate: =INDEX(tbl_Voyage, MATCH([@VoyageID], tbl_Voyage[VoyageID], 0), MATCH([@AnchorField], tbl_Voyage[#Headers], 0))
# DueDate: =IF([@CalendarType]="WD", WORKDAY.INTL([@AnchorDate], [@OffsetDays], "0000011", Holidays!$A$2:$A$100), [@AnchorDate] + [@OffsetDays])
# RAG: =IF([@DueDate]="", "", IF([@DueDate]<TODAY(), "Overdue", IF([@DueDate]<=TODAY()+7, "DueSoon", "OK")))
```

---

## 5. D_Dashboard 설계 (Responsible Party 중심)

### 5.1 레이아웃

```
Row 1:  [제목] TR Document Submission Dashboard
Row 2:  [부제] Last Updated: YYYY-MM-DD HH:MM:SS
Row 3:  [빈 행]

Row 4:  [Party 선택] ─────────────────────────────────────
Row 5:  Responsible Party: [드롭다운: M_Parties[PartyName]] | [Refresh] 버튼

Row 6:  [빈 행]

Row 7:  [KPI 섹션] ─────────────────────────────────────
Row 8:  KPI
Row 9:  Overdue Count              [값]
Row 10: Due in 7 days Count        [값]
Row 11: Due in 14 days Count       [값]
Row 12: Submitted (Pending) Count  [값]
Row 13: Rejected Count             [값]
Row 14: Completion %               [값]

Row 15: [빈 행]

Row 16: [상세 리스트] ────────────────────────────────────
Row 17: [tbl_Tracker 필터링 결과 - 정렬: DueDate ASC]
        (VoyageID | DocCode | DocName | DueDate | Status | EvidenceLink)
```

### 5.2 Dashboard KPI 수식 (Party 필터 적용)

```python
# Party 선택 셀: B5
# KPI 수식 (Party 필터 적용):

B9: =SUMPRODUCT((tbl_Tracker[ResponsiblePartyID]=$B$5)*(tbl_Tracker[RAG]="Overdue"))
B10: =SUMPRODUCT((tbl_Tracker[ResponsiblePartyID]=$B$5)*(tbl_Tracker[RAG]="DueSoon")*(tbl_Tracker[DueDate]<=TODAY()+7))
B11: =SUMPRODUCT((tbl_Tracker[ResponsiblePartyID]=$B$5)*(tbl_Tracker[DueDate]<=TODAY()+14)*(tbl_Tracker[DueDate]>TODAY()+7))
B12: =SUMPRODUCT((tbl_Tracker[ResponsiblePartyID]=$B$5)*(tbl_Tracker[Status]="Submitted")*(tbl_Tracker[AcceptedDate]=""))
B13: =SUMPRODUCT((tbl_Tracker[ResponsiblePartyID]=$B$5)*(tbl_Tracker[Status]="Rejected"))
B14: =IFERROR(
    SUMPRODUCT((tbl_Tracker[ResponsiblePartyID]=$B$5)*((tbl_Tracker[Status]="Accepted")+(tbl_Tracker[Status]="Waived"))) /
    SUMPRODUCT((tbl_Tracker[ResponsiblePartyID]=$B$5)*(tbl_Tracker[VoyageID]<>"")),
    0
)
```

---

## 6. VBA_Pasteboard 설계 (설치 보드)

### 6.1 레이아웃

```
Row 1:  VBA Installation Pasteboard
Row 2:  ============================================================

Row 3:  [Installation Checklist]
Row 4:  StepNo | Action | Done(checkbox) | Notes
Row 5:  1      | VBE에서 모듈 Import | ☐ | modOperations.bas, modDashboard.bas
Row 6:  2      | 참조 라이브러리 확인 | ☐ | Microsoft Scripting Runtime (선택)
Row 7:  3      | 버튼 연결 확인 | ☐ | Dashboard 버튼 매핑
Row 8:  4      | 샘플 Voyage 생성 | ☐ | S_Voyages에 V01 추가
Row 9:  5      | GenerateTrackerRows 실행 | ☐ | T_Tracker 행 생성 확인

Row 10: [빈 행]

Row 11: [Module Inventory]
Row 12: ModuleName | Type | Purpose | Dependencies | InstallOrder | Buttons
Row 13: modOperations | Standard | Init/Generate/Recalc/Validate/Export | None | 1 | btn_Init, btn_Generate, btn_Recalc, btn_Validate, btn_Export
Row 14: modDashboard | Standard | Dashboard refresh/filter | modOperations | 2 | btn_RefreshDashboard
Row 15: Document_Tracker Sheet | Sheet | Worksheet_Change event | None | 3 | (자동)

Row 16: [빈 행]

Row 17: [References Check]
Row 18: Reference | Required | LateBindAllowed | Notes
Row 19: Microsoft Scripting Runtime | Optional | Yes | Dictionary/FSO (Late Binding 권장)
Row 20: Microsoft VBScript Regular Expressions | Optional | Yes | Regex (Late Binding 권장)

Row 21: [빈 행]

Row 22: [Buttons Mapping]
Row 23: Button Name | Macro | Location
Row 24: btn_Init | InitializeWorkbook | Dashboard
Row 25: btn_Generate | GenerateTrackerRows | Dashboard
Row 26: btn_Recalc | RecalcDeadlines | Dashboard
Row 27: btn_Validate | ValidateBeforeExport | Dashboard
Row 28: btn_Export | ExportVoyagePack | Dashboard
Row 29: btn_RefreshDashboard | RefreshDashboard | Dashboard
```

---

## 7. Python 빌더 통합 함수

### 7.1 통합 빌더 함수

```python
def build_tr_dochub_template(output_path: Path) -> Path:
    """Build complete TR_DocHub template with normalized schema"""
    wb = Workbook()
    
    # Remove default sheet
    wb.remove(wb.active)
    
    # Create sheets in order
    create_c_config_sheet(wb)          # Config first
    create_lists_sheet(wb)              # Lists (hidden)
    create_s_voyages_sheet(wb)          # Source: Voyages
    create_m_doccatalog_sheet(wb)       # Master: DocCatalog
    create_m_parties_sheet(wb)          # Master: Parties
    create_r_deadline_rules_sheet(wb)   # Rules: DeadlineRules
    create_t_tracker_sheet(wb)          # Transaction: Tracker
    create_d_dashboard_sheet(wb)        # Dashboard
    create_vba_pasteboard_sheet(wb)     # VBA Code
    create_instructions_sheet(wb)       # Guide
    
    # Save
    wb.save(output_path)
    return output_path
```

---

## 8. 구현 우선순위 (Phase별)

### Phase 1: 핵심 테이블 구조 (1주)
- [ ] S_Voyages (VoyageID 추가)
- [ ] M_DocCatalog (정규화)
- [ ] M_Parties (신규)
- [ ] R_DeadlineRules (신규)
- [ ] T_Tracker (정규화, AnchorDate/DueDate 수식)

### Phase 2: VBA 최소 기능 (1주)
- [ ] InitializeWorkbook()
- [ ] GenerateTrackerRows()
- [ ] RecalcDeadlines() (B안 - VBA 재계산)
- [ ] ValidateBeforeExport()
- [ ] ExportVoyagePack()

### Phase 3: Dashboard + Export (1주)
- [ ] D_Dashboard (Party 중심 KPI)
- [ ] PDF Export (ExportAsFixedFormat)
- [ ] CSV Export (SaveAs)

### Phase 4: 통합 테스트 (1주)
- [ ] 룰 충돌 테스트
- [ ] Anchor 누락 검증
- [ ] Export Pack 품질 확인

---

## 9. QA 체크리스트 (정규화 모델)

- [ ] `tbl_Voyage[VoyageID]` 고유성 검증
- [ ] `tbl_DocCatalog[DocCode]` 고유성 검증
- [ ] `tbl_RuleDeadline[RuleID]` 고유성 검증
- [ ] `tbl_Tracker` (VoyageID, DocCode) 복합키 고유성
- [ ] Rule의 AnchorField가 `tbl_Voyage` 컬럼명과 일치하는지 검증
- [ ] GenerateTrackerRows 시 중복 방지 로직
- [ ] RecalcDeadlines 시 룰 우선순위(Priority) 적용
- [ ] Status=Submitted AND EvidenceRequiredFlag=Y AND EvidenceLink="" 경고
- [ ] Export Pack: PDF/CSV 생성 정상 동작
- [ ] Dashboard KPI가 Party 필터와 일치

---

이 설계안을 기준으로 Python 빌더를 업데이트하고 VBA 모듈을 최소 기능 세트로 구현할 수 있습니다. Agent 모드로 전환하시면 파일 편집을 진행하겠습니다.