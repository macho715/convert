현재 파일 구조를 확인하고, 단일 `.xlsm` 통합 설계안을 정리 중입니다.


[3 tools called]


# TR_DocHub_2026.xlsm 통합 설계안

## 1. 시트 구성 (최종)

```
1. Dashboard          [운영] KPI + 버튼 + 항차/파티 요약
2. Voyage_Schedule    [입력] 항차 마일스톤 (tblVoyage)
3. Doc_Matrix         [설정] 문서 요구사항/리드타임 (tblDoc)
4. Document_Tracker   [메인] 실행 테이블 (tblTracker)
5. Party_Contacts     [설정] 담당자 연락처 (tblContacts)
6. Calendar_View      [뷰] 주간/월간 마감 캘린더
7. Config             [설정] 임계값/기본값
8. Lists              [설정] 드롭다운 소스 (hidden)
9. Holidays           [설정] UAE 휴일/프로젝트 휴무일
10. LOG               [로그] 실행/에러 로그
11. VBA_Pasteboard        [코드] VBA 복붙용 코드 저장소
12. PY_Scripts        [코드] Python 스크립트 텍스트 (선택)
13. Instructions      [가이드] 사용법
```

---

## 2. Dashboard UI 설계 (버튼 + KPI)

### 2.1 Dashboard 레이아웃

```
Row 1:  [제목] TR Document Preparation / Submission Dashboard
Row 2:  [부제] Last Updated: YYYY-MM-DD HH:MM:SS
Row 3:  [빈 행]

Row 4:  [KPI 섹션 헤더] ────────────────────────────────
Row 5:  KPI
Row 6:  Total Docs          [값]
Row 7:  Completed           [값]
Row 8:  Overdue             [값]
Row 9:  Due Soon (<=N days) [값]
Row 10: Completion %        [값]
Row 11: D-7 Count (Amber)   [값]
Row 12: D-3 Count (Red)    [값]
Row 13: D-1 Count (Critical) [값]

Row 14: [빈 행]

Row 15: [버튼 영역] ─────────────────────────────────────
        [AutoRefreshAll] [Export PDF] [Send Reminder] [Create Report]
        [Filter Overdue] [Filter D-3] [Clear Filters] [Export Scripts]

Row 16: [빈 행]

Row 17: [항차 요약 섹션] ────────────────────────────────
Row 18: [항차별 일정 테이블]

Row 25: [파티별 진행률 섹션] ────────────────────────────
Row 26: [파티별 진행률 테이블 + 차트]
```

### 2.2 Dashboard 버튼 매핑

| 버튼 | 매크로 | 설명 |
|------|--------|------|
| AutoRefreshAll | `RefreshAll_ControlTower()` | 전체 갱신 (진행률/서식/마감/KPI) |
| Export PDF | `EXP_ExportToPDF()` | 현재 시트를 PDF로 저장 |
| Send Reminder | `EXP_SendEmailReminder()` | Outlook 리마인더 초안 생성 |
| Create Report | `RPT_CreateVoyageSummary()` | 항차별 요약 리포트 시트 생성 |
| Filter Overdue | `UX_FilterOverdue()` | Document_Tracker에서 마감 초과만 표시 |
| Filter D-3 | `UX_FilterDueSoon()` | D-3 이내 항목만 표시 |
| Clear Filters | `UX_ClearAllFilters()` | 모든 필터 제거 |
| Export Scripts | `EXP_ExportPythonScripts()` | PY_Scripts 시트 내용을 .py 파일로 저장 |

### 2.3 Dashboard KPI 수식 (Config 연동)

```python
# Config 시트 참조:
# B4: DocCutoff_Days
# B5: LandPermitLead_Days  
# B6: DueSoon_Threshold_Days
# B7: Amber_Threshold_Days (D-7)
# B8: Red_Threshold_Days (D-3)
# B9: Critical_Threshold_Days (D-1)

# Dashboard 수식:
B6: =COUNTA(tblTracker[Record ID])
B7: =SUMPRODUCT((tblTracker[Status]="Approved")+(tblTracker[Status]="Submitted"))
B8: =SUMPRODUCT((tblTracker[SUBMISSION DATE]<TODAY())*(tblTracker[SUBMISSION DATE]<>"")*(tblTracker[Status]<>"Approved")*(tblTracker[Status]<>"Submitted")*(tblTracker[Status]<>"Not Required"))
B9: =SUMPRODUCT((tblTracker[SUBMISSION DATE]>=TODAY())*(tblTracker[SUBMISSION DATE]<=TODAY()+Config!$B$6)*(tblTracker[Status]<>"Approved")*(tblTracker[Status]<>"Submitted")*(tblTracker[Status]<>"Not Required")*(tblTracker[SUBMISSION DATE]<>""))
B10: =IFERROR(B7/B6,0)
B11: =SUMPRODUCT((tblTracker[SUBMISSION DATE]>=TODAY())*(tblTracker[SUBMISSION DATE]<=TODAY()+Config!$B$7)*(tblTracker[Status]<>"Approved")*(tblTracker[Status]<>"Submitted")*(tblTracker[Status]<>"Not Required")*(tblTracker[SUBMISSION DATE]<>""))
B12: =SUMPRODUCT((tblTracker[SUBMISSION DATE]>=TODAY())*(tblTracker[SUBMISSION DATE]<=TODAY()+Config!$B$8)*(tblTracker[Status]<>"Approved")*(tblTracker[Status]<>"Submitted")*(tblTracker[Status]<>"Not Required")*(tblTracker[SUBMISSION DATE]<>""))
B13: =SUMPRODUCT((tblTracker[SUBMISSION DATE]>=TODAY())*(tblTracker[SUBMISSION DATE]<=TODAY()+Config!$B$9)*(tblTracker[Status]<>"Approved")*(tblTracker[Status]<>"Submitted")*(tblTracker[Status]<>"Not Required")*(tblTracker[SUBMISSION DATE]<>""))
```

---

## 3. 표 컬럼 표준 (필수/선택, 데이터 유효성, 상태 코드)

### 3.1 Document_Tracker (tblTracker) 컬럼 표준

| 컬럼명 | 필수 | 데이터 유효성 | 설명 |
|--------|------|--------------|------|
| Record ID | ✅ | 자동 생성 | `{Voyage}|{Doc Code}` |
| Voyage | ✅ | Lists!$A$2:$A$8 | 항차명 |
| Site | ✅ | Lists!$E$2:$E$7 | Site-1~6 |
| TR Units | ✅ | 텍스트 | TR 1-2, TR 3-4 등 |
| MZP Arrival | ✅ | 날짜 | 수식: `=INDEX(tblVoyage[...])` |
| Load-out | ✅ | 날짜 | 수식 참조 |
| MZP Departure | ✅ | 날짜 | 수식 참조 |
| AGI Arrival | ✅ | 날짜 | 수식 참조 |
| Doc Deadline | ✅ | 날짜 | 수식 참조 |
| Land Permit By | ✅ | 날짜 | 수식 참조 |
| Doc Code | ✅ | 텍스트 | D001, D002 등 |
| Category | ✅ | Lists!$C$2:$C$8 | Customs & Port, Permit 등 |
| Document Name | ✅ | 텍스트 | |
| Description | ⚪ | 텍스트 | |
| Priority | ✅ | Lists!$B$2:$B$4 | Mandatory, Important, Optional |
| Responsible Party | ✅ | Lists!$F$2:$F$8 | Party_Contacts 참조 |
| Lead Days | ✅ | 숫자 | 영업일 기준 |
| Due Based On | ✅ | Lists!$C$2:$C$8 | MZP Arrival, Load-out 등 |
| Due Offset Days | ⚪ | 숫자 | +/- 조정 |
| SUBMISSION DATE | ✅ | 날짜 | 수식: `WORKDAY.INTL(기준일, -Lead Days, Holidays)` |
| Start By (Prep) | ✅ | 날짜 | 수식: `=SUBMISSION DATE - Lead Days` |
| Status | ✅ | Lists!$A$2:$A$8 | Not Started, In Progress, Submitted, Approved, Rejected, On Hold, Not Required |
| Submitted Date | ⚪ | 날짜 | 사용자 입력 |
| Approved/Received Date | ⚪ | 날짜 | 사용자 입력 |
| Remarks | ⚪ | 텍스트 | |
| File Link | ⚪ | 하이퍼링크 | `HYPERLINK("file:///...")` |
| Revision | ⚪ | 텍스트 | v1.0, v2.0 등 |
| Transmittal No | ⚪ | 텍스트 | |
| Last Updated | ✅ | 날짜/시간 | 자동 (Worksheet_Change) |
| Updated By | ✅ | 텍스트 | 자동 (Environ$("username")) |

### 3.2 Voyage_Schedule (tblVoyage) 컬럼 표준

| 컬럼명 | 필수 | 데이터 유효성 | 설명 |
|--------|------|--------------|------|
| Voyage | ✅ | 텍스트 | Voyage 1, Voyage 2 등 |
| Site | ✅ | Lists!$E$2:$E$7 | Site-1~6 |
| TR Units | ✅ | 텍스트 | TR 1-2 등 |
| MZP Arrival | ✅ | 날짜 | 입력 또는 Inputs!$B$3 참조 |
| Load-out | ✅ | 날짜 | 입력 또는 Inputs!$B$4 참조 |
| MZP Departure | ✅ | 날짜 | 입력 또는 Inputs!$B$6 참조 |
| AGI Arrival | ✅ | 날짜 | 입력 또는 수식 |
| Doc Deadline | ✅ | 날짜 | 수식: `=MZP Departure - Config!$B$4` |
| Land Permit By | ✅ | 날짜 | 수식: `=AGI Arrival - Config!$B$5` |
| Submission Date | ✅ | 날짜 | 수식: `=MIN(Doc Deadline, Land Permit By)` |
| Status | ⚪ | Lists!$A$2:$A$8 | Open, Closed 등 |
| Remarks | ⚪ | 텍스트 | |

### 3.3 Doc_Matrix (tblDoc) 컬럼 표준

| 컬럼명 | 필수 | 데이터 유효성 | 설명 |
|--------|------|--------------|------|
| Doc Code | ✅ | 텍스트 | D001, D002 등 (고유) |
| Category | ✅ | Lists!$C$2:$C$8 | |
| Document Name | ✅ | 텍스트 | |
| Description | ⚪ | 텍스트 | |
| Priority | ✅ | Lists!$B$2:$B$4 | |
| Responsible Party | ✅ | Lists!$F$2:$F$8 | |
| Lead Days | ✅ | 숫자 | 영업일 기준 |
| Due Based On | ✅ | Lists!$C$2:$C$8 | AUTO, Doc Deadline, Land Permit By 등 |
| Due Offset Days | ⚪ | 숫자 | +/- 조정 |
| Required (Y/N) | ✅ | Lists!$D$2:$D$3 | Y/N |
| Approval Stage | ⚪ | 텍스트 | Submit → Review → Approve |
| Default Recipient | ⚪ | 텍스트 | |
| Notes | ⚪ | 텍스트 | |

### 3.4 상태 코드 체계 (Lists 시트)

```
Status (Lists!A2:A8):
1. Not Started      [빨강] 초기 상태
2. In Progress      [노랑] 진행 중
3. Submitted        [연두] 제출 완료
4. Approved         [초록] 승인 완료
5. Rejected         [회색] 반려
6. On Hold          [파랑] 보류
7. Not Required     [회색] 불필요
```

---

## 4. Calendar_View 시트 설계

### 4.1 레이아웃

```
Row 1:  [제목] Calendar View - Submission Deadlines
Row 2:  [필터] Voyage: [드롭다운] | Party: [드롭다운] | Period: [This Week / Next Week / This Month]
Row 3:  [빈 행]

Row 4:  [주간 뷰] ─────────────────────────────────────
        Mon    Tue    Wed    Thu    Fri    Sat    Sun
Row 5:  [날짜] [날짜] [날짜] [날짜] [날짜] [날짜] [날짜]
Row 6:  [항목] [항목] [항목] [항목] [항목] [항목] [항목]
        ...

Row 20: [월간 뷰] ─────────────────────────────────────
        [달력 그리드: 7열 × 5-6행]
```

### 4.2 Calendar_View 수식 로직

```python
# 주간 뷰: FILTER 함수로 SUBMISSION DATE가 해당 주에 속하는 항목 추출
# 월간 뷰: SUMPRODUCT로 날짜별 카운트 집계

# 예시 (주간 뷰, 월요일 열):
=IFERROR(
    FILTER(
        tblTracker[[Voyage]:[SUBMISSION DATE]],
        (WEEKDAY(tblTracker[SUBMISSION DATE],2)=1)*
        (tblTracker[SUBMISSION DATE]>=TODAY())*
        (tblTracker[SUBMISSION DATE]<=TODAY()+7)
    ),
    ""
)
```

---

## 5. VBA_Pasteboard 시트 설계 (복붙용 코드 저장소)

### 5.1 구조

```
Column A: 모듈명/섹션명
Column B: 설명/사용법
Column C: 코드 (긴 텍스트는 여러 행으로 분할)

예시:
A1: modControlTower
B1: Main entry point - RefreshAll_ControlTower()
C1: [코드 시작]
C2: [코드 계속]
...
```

### 5.2 섹션 구분

```
Row 1:  VBA Code Repository (Copy & Paste into VBA Editor)
Row 2:  ============================================================
Row 3:  
Row 4:  [SECTION 1] modControlTower
Row 5:  [설명] Main orchestration module
Row 6:  [코드] ...
Row 20: 
Row 21: ============================================================
Row 22: [SECTION 2] modTRDocTracker
Row 23: [설명] TR Tracker core functions
Row 24: [코드] ...
Row 50:
Row 51: ============================================================
Row 52: [SECTION 3] modDocGapMacros
Row 53: [설명] DocGap integration macros
Row 54: [코드] ...
Row 70:
Row 71: ============================================================
Row 72: [SECTION 4] Document_Tracker Sheet Code
Row 73: [설명] Worksheet_Change event handler
Row 74: [코드] ...
Row 85:
Row 86: ============================================================
Row 87: [SECTION 5] ThisWorkbook Code
Row 88: [설명] Workbook_Open / BeforeClose events
Row 89: [코드] ...
```

### 5.3 VBA_Pasteboard 시트 생성 코드 (Python)

```python
def create_VBA_Pasteboard_sheet(wb):
    """Create VBA_Pasteboard sheet with code repository"""
    if "VBA_Pasteboard" not in wb.sheetnames:
        ws_vba = wb.create_sheet("VBA_Pasteboard")
    else:
        ws_vba = wb["VBA_Pasteboard"]
        ws_vba.delete_rows(1, ws_vba.max_row)
    
    # Header
    ws_vba["A1"] = "VBA Code Repository"
    ws_vba["A1"].font = Font(bold=True, size=16, color="1E3A5F")
    ws_vba["B1"] = "Copy & Paste into VBA Editor (Alt+F11)"
    ws_vba["B1"].font = Font(italic=True, size=10)
    
    # Section headers
    sections = [
        ("modControlTower", "Main orchestration - RefreshAll_ControlTower()"),
        ("modTRDocTracker", "TR Tracker core functions (TR_ prefix)"),
        ("modDocGapMacros", "DocGap integration (DG_ prefix)"),
        ("modExportPack", "Export/Email functions (EXP_ prefix)"),
        ("modReports", "Report generation (RPT_ prefix)"),
        ("modUX", "User experience helpers (UX_ prefix)"),
        ("Document_Tracker Sheet", "Worksheet_Change event handler"),
        ("ThisWorkbook", "Workbook_Open / BeforeClose events"),
    ]
    
    row = 3
    for module_name, description in sections:
        ws_vba.cell(row, 1).value = "=" * 50
        ws_vba.cell(row, 1).font = Font(bold=True)
        row += 1
        ws_vba.cell(row, 1).value = f"[{module_name}]"
        ws_vba.cell(row, 1).font = Font(bold=True, size=12)
        ws_vba.cell(row, 2).value = description
        ws_vba.cell(row, 2).font = Font(italic=True)
        row += 1
        ws_vba.cell(row, 1).value = "See attached .bas file or copy from source code"
        ws_vba.cell(row, 1).font = Font(size=9, color="808080")
        row += 2
    
    # Format
    ws_vba.column_dimensions['A'].width = 30
    ws_vba.column_dimensions['B'].width = 60
    ws_vba.column_dimensions['C'].width = 100
    
    for row_num in range(1, ws_vba.max_row + 1):
        cell = ws_vba.cell(row_num, 1)
        cell.alignment = Alignment(wrap_text=True, vertical='top')
```

---

## 6. PY_Scripts 시트 설계 (선택)

### 6.1 구조

```
Column A: 파일명
Column B: 설명
Column C: 코드 (여러 행)

예시:
A1: create_tr_document_tracker_v2.py
B1: Template generator - Creates TR Tracker Excel file
C1: [Python 코드 시작]
C2: [계속]
...
```

### 6.2 Export Scripts 버튼 매크로

```vba
Public Sub EXP_ExportPythonScripts()
    Dim ws As Worksheet
    Dim scriptName As String
    Dim scriptCode As String
    Dim filePath As String
    Dim fso As Object
    Dim fileNum As Integer
    
    Set ws = ThisWorkbook.Sheets("PY_Scripts")
    Set fso = CreateObject("Scripting.FileSystemObject")
    
    filePath = ThisWorkbook.Path
    If filePath = "" Then filePath = Environ("USERPROFILE") & "\Documents"
    
    Dim row As Long
    row = 2
    Do While ws.Cells(row, 1).Value <> ""
        scriptName = ws.Cells(row, 1).Value
        If Right(scriptName, 3) = ".py" Or Right(scriptName, 4) = ".txt" Then
            ' Collect code from column C
            scriptCode = ""
            Dim codeRow As Long
            codeRow = row
            Do While ws.Cells(codeRow, 3).Value <> "" Or codeRow = row
                If ws.Cells(codeRow, 3).Value <> "" Then
                    scriptCode = scriptCode & ws.Cells(codeRow, 3).Value & vbCrLf
                End If
                codeRow = codeRow + 1
            Loop
            
            ' Write file
            fileNum = FreeFile
            Open filePath & "\" & scriptName For Output As #fileNum
            Print #fileNum, scriptCode
            Close #fileNum
        End If
        
        ' Find next script (skip to next non-empty A cell)
        row = row + 1
        Do While ws.Cells(row, 1).Value = "" And row < ws.Cells(ws.Rows.Count, 1).End(xlUp).Row
            row = row + 1
        Loop
    Loop
    
    MsgBox "Python scripts exported to: " & filePath, vbInformation
End Sub
```

---

## 7. Holidays 시트 설계 (WORKDAY.INTL 지원)

### 7.1 구조

```
Column A: Date
Column B: Holiday Name
Column C: Type (UAE National / Project / Other)

예시:
A2: 2026-01-01
B2: New Year's Day
C2: UAE National

A3: 2026-01-27
B3: Project Milestone
C3: Project
```

### 7.2 SUBMISSION DATE 수식 업데이트

```python
# Document_Tracker의 SUBMISSION DATE 수식:
# 기존: WORKDAY(기준일, -Lead Days)
# 변경: WORKDAY.INTL(기준일, -Lead Days, "0000011", Holidays!$A$2:$A$100)

# Python 생성 시:
ws_tr.cell(row=row_cursor, column=20, value=(
    f"=IF(R{row_cursor}=\"Doc Deadline\","
    f"WORKDAY.INTL(I{row_cursor},-Q{row_cursor},\"0000011\",Holidays!$A$2:$A$100),"
    f"IF(R{row_cursor}=\"Land Permit By\","
    f"WORKDAY.INTL(J{row_cursor},-Q{row_cursor},\"0000011\",Holidays!$A$2:$A$100),"
    f"..."
    f"))"
    f"+S{row_cursor}"  # Due Offset Days
))
```

---

## 8. 통합 Python 빌더 업데이트 (create_tr_document_tracker_v2.py)

### 8.1 추가 시트 생성 함수

```python
def create_calendar_view_sheet(wb):
    """Create Calendar_View sheet for deadline visualization"""
    ws_cal = wb.create_sheet("Calendar_View")
    ws_cal["A1"] = "Calendar View - Submission Deadlines"
    ws_cal["A1"].font = Font(bold=True, size=16, color="1E3A5F")
    
    # Filter row
    ws_cal["A2"] = "Voyage:"
    ws_cal["B2"] = "All"
    ws_cal["D2"] = "Party:"
    ws_cal["E2"] = "All"
    ws_cal["G2"] = "Period:"
    ws_cal["H2"] = "This Week"
    
    # Weekly view header
    ws_cal["A4"] = "Weekly View"
    ws_cal["A4"].font = Font(bold=True, size=12)
    
    weekdays = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"]
    for col, day in enumerate(weekdays, start=1):
        ws_cal.cell(5, col).value = day
        ws_cal.cell(5, col).font = Font(bold=True)
        ws_cal.cell(5, col).fill = PatternFill("solid", fgColor="D9D9D9")
    
    # Monthly view header
    ws_cal["A20"] = "Monthly View"
    ws_cal["A20"].font = Font(bold=True, size=12)
    
    # Calendar grid (simplified - actual implementation would calculate dates)
    # ...

def create_holidays_sheet(wb):
    """Create Holidays sheet for WORKDAY.INTL"""
    ws_hol = wb.create_sheet("Holidays")
    ws_hol["A1"] = "Date"
    ws_hol["B1"] = "Holiday Name"
    ws_hol["C1"] = "Type"
    
    for cell in (ws_hol["A1"], ws_hol["B1"], ws_hol["C1"]):
        cell.font = Font(bold=True)
        cell.fill = PatternFill("solid", fgColor="1F4E79")
        cell.font = Font(bold=True, color="FFFFFF")
    
    # Sample UAE holidays
    uae_holidays = [
        (date(2026, 1, 1), "New Year's Day", "UAE National"),
        (date(2026, 5, 1), "Labour Day", "UAE National"),
        # Add more as needed
    ]
    
    for i, (hol_date, name, htype) in enumerate(uae_holidays, start=2):
        ws_hol.cell(i, 1).value = hol_date
        ws_hol.cell(i, 2).value = name
        ws_hol.cell(i, 3).value = htype
        ws_hol.cell(i, 1).number_format = "yyyy-mm-dd"
```

---

## 9. 최종 통합 빌더 실행 순서

```bash
# Step 1: TR Tracker 템플릿 생성 (모든 시트 포함)
python create_tr_document_tracker_v2.py --output TR_DocHub_Template.xlsx

# Step 2: DocGap 패치 적용 (Inputs 시트 추가)
python build_docgap_v3_1_operational.py \
    --in TR_DocHub_Template.xlsx \
    --out TR_DocHub_2026_Template.xlsx

# Step 3: Excel에서 .xlsm 변환
# - 파일 열기 → 다른 이름으로 저장 → .xlsm 선택

# Step 4: VBA 모듈 Import
# - Alt+F11 → 파일 → 가져오기:
#   1. modControlTower.bas
#   2. modTRDocTracker.bas (리네임된 버전)
#   3. modDocGapMacros.bas (리네임된 버전)
#   4. modExportPack.bas (신규)
#   5. modReports.bas (신규)
#   6. modUX.bas (신규)

# Step 5: 시트 코드 적용
# - Document_Tracker 시트 → 코드 보기 → Document_Tracker_Sheet_Code.txt 붙여넣기
# - ThisWorkbook → Workbook_Open/BeforeClose 코드 추가

# Step 6: Dashboard 버튼 생성
# - 개발자 도구 → 삽입 → 양식 컨트롤 → 버튼
# - 각 버튼에 매크로 할당
```

---

## 10. 배포 체크리스트

- [ ] `.xlsm` 파일 생성 완료
- [ ] VBA 모듈 Import 완료
- [ ] 시트 코드 적용 완료
- [ ] Dashboard 버튼 매핑 완료
- [ ] VBA_Pasteboard 시트에 코드 텍스트 포함
- [ ] PY_Scripts 시트에 Python 코드 포함 (선택)
- [ ] Instructions 시트에 사용 가이드 포함
- [ ] 매크로 보안 설정 확인 (신뢰 위치 또는 디지털 서명)
- [ ] 테스트: RefreshAll_ControlTower() 실행
- [ ] 테스트: PDF 내보내기
- [ ] 테스트: 이메일 리마인더 (Outlook 환경)

---

이 설계안을 기준으로 Python 빌더를 업데이트하고 VBA 모듈을 통합할 수 있습니다. Agent 모드로 전환하시면 파일 편집을 진행하겠습니다.